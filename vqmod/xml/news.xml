
<modification>
	<id>News edit in admin page</id>
	<version>1.5.x</version>
	<vqmver>0.2</vqmver>
	<author>Fanha Giang</author>
	<file name="admin/controller/common/filemanager.php">
		<operation>
			<search position="before"><![CDATA[public function image() {]]></search>
			<add><![CDATA[
	public function image2() {
		$this->load->model('tool/image');
		
		if (isset($this->request->get['image'])) {
			$this->response->setOutput($this->model_tool_image->resize(html_entity_decode($this->request->get['image'], ENT_QUOTES, 'UTF-8'), 100, 100));
		}
	}
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/information/sitemap.php">
		<operation>
			<search position="before"><![CDATA[
		$this->data['categories'] = array();
			]]></search>
			<add><![CDATA[
		$this->load->model('catalog/news');	
		
		$this->data['news_categories'] = array();
					
		$categories_1 = $this->model_catalog_news->getCategories(0);
		
		foreach ($categories_1 as $category_1) {
			$level_2_data = array();
			
			$categories_2 = $this->model_catalog_news->getCategories($category_1['news_category_id']);
			
			foreach ($categories_2 as $category_2) {
				$level_3_data = array();
				
				$categories_3 = $this->model_catalog_news->getCategories($category_2['news_category_id']);
				
				foreach ($categories_3 as $category_3) {
					$level_3_data[] = array(
						'name' => $category_3['name'],
						'href' => $this->url->link('news/category', 'npath=' . $category_1['news_category_id'] . '_' . $category_2['news_category_id'] . '_' . $category_3['news_category_id'])
					);
				}
				
				$level_2_data[] = array(
					'name'     => $category_2['name'],
					'children' => $level_3_data,
					'href'     => $this->url->link('news/category', 'npath=' . $category_1['news_category_id'] . '_' . $category_2['news_category_id'])	
				);					
			}
			
			$this->data['news_categories'][] = array(
				'name'     => $category_1['name'],
				'children' => $level_2_data,
				'href'     => $this->url->link('news/category', 'npath=' . $category_1['news_category_id'])
			);
		}
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/default/template/information/sitemap.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
  <?php echo $content_bottom; ?></div>
			]]></search>
			<add><![CDATA[
    <div class="right">
      <ul>
        <?php foreach ($news_categories as $category_1) { ?>
        <li><a href="<?php echo $category_1['href']; ?>"><?php echo $category_1['name']; ?></a>
          <?php if ($category_1['children']) { ?>
          <ul>
            <?php foreach ($category_1['children'] as $category_2) { ?>
            <li><a href="<?php echo $category_2['href']; ?>"><?php echo $category_2['name']; ?></a>
              <?php if ($category_2['children']) { ?>
              <ul>
                <?php foreach ($category_2['children'] as $category_3) { ?>
                <li><a href="<?php echo $category_3['href']; ?>"><?php echo $category_3['name']; ?></a></li>
                <?php } ?>
              </ul>
              <?php } ?>
            </li>
            <?php } ?>
          </ul>
          <?php } ?>
        </li>
        <?php } ?>
      </ul>
    </div>	
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/common/seo_url.php">
		<operation>
			<search position="before"><![CDATA[if ($url[0] == 'category_id') {]]></search>
				<add><![CDATA[
					if ($url[0] == 'news_id') {
						$this->request->get['news_id'] = $url[1];
					}
					if ($url[0] == 'news_category_id') {
						if (!isset($this->request->get['npath'])) {
							$this->request->get['npath'] = $url[1];
						} else {
							$this->request->get['npath'] .= '_' . $url[1];
						}
					}      
				]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[ elseif ($key == 'path') {]]></search>
			<add><![CDATA[ 
				elseif (($data['route'] == 'news/news' || $data['route'] == 'news/category') && $key == 'npath') {
					$categories = explode('_', $value);
					
					foreach ($categories as $category) {
						$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = 'news_category_id=" . (int)$category . "'");
				
						if ($query->num_rows) {
							$url .= '/' . $query->row['keyword'];
						}							
					}
					
					unset($data[$key]);
				} elseif ($key == 'path') {
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[} elseif (isset($this->request->get['path'])) {]]></search>
			<add><![CDATA[
				}elseif (isset($this->request->get['npath']) && $url[0] == 'news_category_id') {
					if (isset($this->request->get['news_id'])) {
						$this->request->get['route'] = 'news/news';
					} else {
						$this->request->get['route'] = 'news/category';
					}
				}elseif (isset($this->request->get['news_id'])) {
					$this->request->get['route'] = 'news/news';
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="before"><![CDATA[
				'name'     => $category['name'],
			]]></search>
			<add><![CDATA[
				'sort_order'     => $category['sort_order'],
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/common/header.tpl')) {
				]]></search>
			<add><![CDATA[
				$this->load->model('catalog/news');
				$categories_1 = $this->model_catalog_news->getCategories(0);
		
				foreach ($categories_1 as $category) {
					if ($category['top']) {
						$children_data = array();
				
						$children = $this->model_catalog_news->getCategories($category['news_category_id']);
				
						foreach ($children as $child) {
							$data = array(
								'filter_news_category_id'  => $child['news_category_id'],
								'filter_sub_category' => true	
							);		
						
							$total = $this->model_catalog_news->getTotalNews($data);
									
							$children_data[] = array(
								'name'  => $child['name'] . ' (' . $total . ')',
								'href'  => $this->url->link('news/category', 'npath=' . $category['news_category_id'] . '_' . $child['news_category_id'])	
							);					
						}
						
						// Level 1
						$this->data['categories_news'][] = array(
							'name'     => $category['name'],
							'sort_order'     => $category['sort_order'],
							'children' => $children_data,
							'column'   => $category['column'] ? $category['column'] : 1,
							'href'     => $this->url->link('news/category', 'npath=' . $category['news_category_id'])
						);
					}
				}
					
				function sortByOneKey(array $array, $key, $asc = true) {
					$result = array();
					   
					$values = array();
					foreach ($array as $id => $value) {
						$values[$id] = isset($value[$key]) ? $value[$key] : '';
					}
					   
					if ($asc) {
						asort($values);
					}
					else {
						arsort($values);
					}
					   
					foreach ($values as $key => $value) {
						$result[$key] = $array[$key];
					}
					   
					return $result;
				}
				if(isset($this->data['categories_news']) && $this->data['categories_news']!=null)
				{
					$this->data['categories_news'] = sortByOneKey($this->data['categories_news'], 'sort_order');
				}
			]]></add>
		</operation>
	</file>
</modification>
