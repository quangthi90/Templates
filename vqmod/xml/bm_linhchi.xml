<modification>
	<id>for site linhchinonglam.edu.vn</id>
	<version>2.0.x</version>
	<vqmver>1.0</vqmver>
	<author>Bommer Luu</author>
	<file name="admin/controller/sale/order.php">
		<operation>
			<search position="after"><![CDATA[
				'filter_date_modified' => $filter_date_modified,
			]]></search>
			<add><![CDATA[
				'filter_affiliate_id'  => isset($this->request->get['affiliate_id']) ? $this->request->get['affiliate_id'] : null,
			]]></add>
		</operation>
	</file>
	<file name="admin/model/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
				$sort_data = array(
			]]></search>
			<add><![CDATA[
				if (!empty($data['filter_affiliate_id'])) {
					$sql .= " AND o.affiliate_id = '" . (int)$data['filter_affiliate_id'] . "'";
				}
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="20"><![CDATA[
				$sql = "SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order`";
			]]></search>
			<add><![CDATA[
				if (!empty($data['filter_affiliate_id'])) {
					$sql .= " AND affiliate_id = '" . (int)$data['filter_affiliate_id'] . "'";
				}
			]]></add>
		</operation>
	</file>
	<file name="admin/language/english/default.php">
		<operation>
			<search position="after"><![CDATA[
				$_['button_currency']               = 'Refresh Currency Values';
			]]></search>
			<add><![CDATA[
				$_['button_orders']                 = 'Orders';
			]]></add>
		</operation>
	</file>
	<file name="admin/language/vietnamese/default.php">
		<operation>
			<search position="after"><![CDATA[
				$_['button_add_profile']      = 'Add Profile';
			]]></search>
			<add><![CDATA[
				$_['button_orders']           = 'Đơn đặt hàng';
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/marketing/affiliate_list.tpl">
		<operation>
			<search position="before"><![CDATA[
				<a href="<?php echo $affiliate['edit']; ?>" data-toggle="tooltip" title="<?php echo $button_edit; ?>" class="btn btn-primary"><i class="fa fa-pencil"></i></a></td>
			]]></search>
			<add><![CDATA[
				<a href="<?php echo $affiliate['orders']; ?>" data-toggle="tooltip" title="<?php echo $button_orders; ?>" class="btn btn-primary"><i class="fa fa-shopping-cart"></i></a>
			]]></add>
		</operation>
	</file>
	<file name="admin/language/english/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
				$_['entry_meta_description'] = 'Meta Tag Description';
			]]></search>
			<add><![CDATA[
				$_['entry_meta_description'] = 'Product introduce';
			]]></add>
		</operation>
	</file>
	<file name="admin/language/vietnamese/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
				$_['entry_meta_description'] = 'Mô tả từ khóa:';
			]]></search>
			<add><![CDATA[
				$_['entry_meta_description'] = 'Giới thiệu sản phẩm';
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/common/menu.php">
		<operation>
			<search position="after"><![CDATA[
				$data['text_help'] = $this->language->get('text_help');
			]]></search>
			<add><![CDATA[
				$data['text_home_intro'] = $this->language->get('text_home_intro');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$data['geo_zone'] = $this->url->link('localisation/geo_zone', 'token=' . $this->session->data['token'], 'SSL');
			]]></search>
			<add><![CDATA[
				$data['home_intro'] = $this->url->link('plugin/introduce', 'token=' . $this->session->data['token'], 'SSL');
			]]></add>
		</operation>
	</file>
	<file name="admin/language/english/common/menu.php">
		<operation>
			<search position="after"><![CDATA[
				$_['text_geo_zone']                    = 'Geo Zones';
			]]></search>
			<add><![CDATA[
				$_['text_home_intro']                  = 'Home Introduce';
			]]></add>
		</operation>
	</file>
	<file name="admin/language/vietnamese/common/menu.php">
		<operation>
			<search position="after"><![CDATA[
				$_['text_geo_zone']                    = 'Vùng Geo';
			]]></search>
			<add><![CDATA[
				$_['text_home_intro']                  = 'Giới thiệu ở trang chủ';
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/common/menu.tpl">
		<operation>
			<search position="after"><![CDATA[
				<li><a href="<?php echo $contact; ?>"><?php echo $text_contact; ?></a></li>
			]]></search>
			<add><![CDATA[
				<li><a href="<?php echo $home_intro; ?>"><?php echo $text_home_intro; ?></a></li>
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/marketing/affiliate.php">
		<operation>
			<search position="after"><![CDATA[
				$data['column_balance'] = $this->language->get('column_balance');
			]]></search>
			<add><![CDATA[
				$data['column_total'] = $this->language->get('column_total');
				$data['button_orders'] = $this->language->get('button_orders');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				'unlock'       => $unlock,
			]]></search>
			<add><![CDATA[
				'total'		   => $this->currency->format($result['total'], $this->config->get('config_currency')),
				'orders'       => $this->url->link('sale/order', 'token=' . $this->session->data['token'] . '&affiliate_id=' . $result['affiliate_id'], 'SSL'),
			]]></add>
		</operation>
	</file>
	<file name="admin/language/english/marketing/affiliate.php">
		<operation>
			<search position="after"><![CDATA[
				$_['column_balance']            = 'Balance';
			]]></search>
			<add><![CDATA[
				$_['column_total']            = 'Total';
			]]></add>
		</operation>
	</file>
	<file name="admin/language/vietnamese/marketing/affiliate.php">
		<operation>
			<search position="after"><![CDATA[
				$_['column_balance']            = 'Balance';
			]]></search>
			<add><![CDATA[
				$_['column_total']            = 'Total';
			]]></add>
		</operation>
	</file>
	<file name="admin/model/marketing/affiliate.php">
		<operation>
			<search position="replace"><![CDATA[
				$sql = "SELECT *, CONCAT(a.firstname, ' ', a.lastname) AS name, (SELECT SUM(at.amount) FROM " . DB_PREFIX . "affiliate_transaction at WHERE at.affiliate_id = a.affiliate_id GROUP BY at.affiliate_id) AS balance FROM " . DB_PREFIX . "affiliate a";
			]]></search>
			<add><![CDATA[
				$sql = "SELECT *, CONCAT(a.firstname, ' ', a.lastname) AS name, (SELECT SUM(at.amount) FROM " . DB_PREFIX . "affiliate_transaction at WHERE at.affiliate_id = a.affiliate_id GROUP BY at.affiliate_id) AS balance, (SELECT SUM(od.total) FROM " . DB_PREFIX . "`order` od WHERE od.affiliate_id = a.affiliate_id GROUP BY od.affiliate_id) AS total FROM " . DB_PREFIX . "affiliate a";
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$this->event->trigger('pre.admin.affiliate.edit', $data);
			]]></search>
			<add><![CDATA[
				$affiliate = $this->getAffiliate($affiliate_id);
				if ($affiliate['code'] == $data['code']) return;

				$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "affiliate WHERE code = '" . $this->db->escape($data['code']) . "'");
				if ($total = $query->row['total'] > 0) {
					$data['code'] .= '-' . ($total + 1);
				}
				$this->db->query("UPDATE " . DB_PREFIX . "affiliate SET code = '" . $this->db->escape($data['code']) . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");
				
				$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE query = 'affiliate_id=" . $affiliate_id . "'");
				
				if (isset($query->row['url_alias_id']) && $alias_id = $query->row['url_alias_id']) {
					$this->db->query("UPDATE " . DB_PREFIX . "url_alias SET keyword = '" . $data['code'] . "' WHERE url_alias_id = '" . $alias_id . "'");
				} else {
					$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET keyword = '" . $data['code'] . "', query = 'affiliate_id=" . $affiliate_id . "'");
				}
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/marketing/affiliate_list.tpl">
		<operation>
			<search position="after"><![CDATA[
				<td class="text-right"><?php echo $column_balance; ?></td>
			]]></search>
			<add><![CDATA[
				<td class="text-right"><?php echo $column_total; ?></td>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				<td class="text-right"><?php echo $affiliate['balance']; ?></td>
			]]></search>
			<add><![CDATA[
				<td class="text-right"><?php echo $affiliate['total']; ?></td>
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
				$data['entry_icon']
			]]></search>
			<add><![CDATA[
				$data['entry_fixed_banner'] = $this->language->get('entry_fixed_banner');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$data['help_google_analytics']
			]]></search>
			<add><![CDATA[
				$data['help_fixed_banner'] = $this->language->get('help_fixed_banner');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				if (isset($this->request->post['config_image_category_width'])) {
			]]></search>
			<add><![CDATA[
				if (isset($this->request->post['config_fixed_banner'])) {
					$data['config_fixed_banner'] = $this->request->post['config_fixed_banner'];
				} else {
					$data['config_fixed_banner'] = $this->config->get('config_fixed_banner');
				}

				$this->load->model('design/banner');

				$data['banners'] = $this->model_design_banner->getBanners();
			]]></add>
		</operation>
	</file>
	<file name="admin/language/english/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
				$_['entry_icon']
			]]></search>
			<add><![CDATA[
				$_['entry_fixed_banner']               = 'Fixed Banner';
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$_['help_google_analytics']
			]]></search>
			<add><![CDATA[
				$_['help_fixed_banner']				   = 'Banner in left bottom\'s conner';
			]]></add>
		</operation>
	</file>
	<file name="admin/language/vietnamese/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
				$_['entry_icon']
			]]></search>
			<add><![CDATA[
				$_['entry_fixed_banner']               = 'Fixed Banner';
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$_['help_google_analytics']
			]]></search>
			<add><![CDATA[
				$_['help_fixed_banner']				   = 'Banner quảng cáo ở góc trái gần Footer';
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/setting/setting.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
				for="input-image-category-width"
			]]></search>
			<add><![CDATA[
				<div class="form-group">
	                <label class="col-sm-2 control-label" for="input-fixed-banner"><span data-toggle="tooltip" title="<?php echo $help_fixed_banner; ?>"><?php echo $entry_fixed_banner; ?></span></label>
	                <div class="col-sm-10">
	                  <select name="config_fixed_banner" id="input-fixed-banner" class="form-control">
	                      <?php foreach ($banners as $banner) { ?>
	                      <?php if ($banner['banner_id'] == $config_fixed_banner) { ?>
	                      <option value="<?php echo $banner['banner_id']; ?>" selected="selected"><?php echo $banner['name']; ?></option>
	                      <?php } else { ?>
	                      <option value="<?php echo $banner['banner_id']; ?>"><?php echo $banner['name']; ?></option>
	                      <?php } ?>
	                      <?php } ?>
	                    </select>
	                </div>
	              </div>
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
				$data['text_all'] = $this->language->get('text_all');
			]]></search>
			<add><![CDATA[
				$data['text_register_affiliate'] = $this->language->get('text_register_affiliate');
				$data['text_login_affiliate'] = $this->language->get('text_login_affiliate');
				$data['text_register_user'] = $this->language->get('text_register_user');
				$data['text_login_user'] = $this->language->get('text_login_user');
				$data['text_product'] = $this->language->get('text_product');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$data['login'] = $this->url->link('account/login', '', 'SSL');
			]]></search>
			<add><![CDATA[
				$data['register_affiliate'] = $this->url->link('affiliate/register', '', 'SSL');
				$data['login_affiliate'] = $this->url->link('affiliate/login', '', 'SSL');
				$data['contact'] = $this->url->link('information/contact', '', '');
				$data['account'] = $this->url->link('account/account', '', 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$data['text_logged'] = sprintf($this->language->get('text_logged'), $this->url->link('account/account', '', 'SSL'), $this->customer->getFirstName(), $this->url->link('account/logout', '', 'SSL'));
			]]></search>
			<add><![CDATA[
				if ( $this->affiliate->isLogged() )
					$data['text_logged'] = sprintf($this->affiliate->getFirstName() . ' ' . $this->affiliate->getLastname(), $this->url->link('affiliate/account', '', 'SSL'), $this->affiliate->getFirstName(), $this->url->link('account/logout', '', 'SSL'));
				else
					$data['text_logged'] = sprintf($this->customer->getFirstName() . ' ' . $this->customer->getLastname(), $this->url->link('account/account', '', 'SSL'), $this->customer->getFirstName(), $this->url->link('account/logout', '', 'SSL'));
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$data['logged'] = $this->customer->isLogged();
			]]></search>
			<add><![CDATA[
				$data['logged'] = $this->customer->isLogged() || $this->affiliate->isLogged();
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$data['account'] = $this->url->link('account/account', '', 'SSL');
			]]></search>
			<add><![CDATA[
				if ( $this->affiliate->isLogged() )
					$data['account'] = $this->url->link('affiliate/account', '', 'SSL');
				else
					$data['account'] = $this->url->link('account/account', '', 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/common/header.tpl')) {
			]]></search>
			<add><![CDATA[
				// check affiliate
				if ( isset($this->session->data['tracking']) || $this->affiliate->isLogged() ) {
					if ( !$code = $this->affiliate->getCode() ) {
						$code = $this->session->data['tracking'];
					}
					$this->load->model('affiliate/affiliate');
					if ( $affiliate = $this->model_affiliate_affiliate->getAffiliateByCode($code) ) {
						$data['href_home'] = $this->url->link('common/home', 'tracking=0', 'SSL');
					}
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$data['logout'] = $this->url->link('account/logout', '', 'SSL');
			]]></search>
			<add><![CDATA[
				if ( !$this->affiliate->isLogged() )
					$data['logout'] = $this->url->link('account/logout', '', 'SSL');
				else
					$data['logout'] = $this->url->link('affiliate/logout', '', 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				// Menu
			]]></search>
			<add><![CDATA[
				//Load banners
				$data['left_bottom_banners'] = array();

				$results = $this->model_design_banner->getBanner($this->config->get('config_fixed_banner'));

				foreach ($results as $result) {
					if (is_file(DIR_IMAGE . $result['image'])) {
						$data['left_bottom_banners'][] = array(
							'title' => $result['title'],
							'link'  => $result['link'],
							'image' => $this->model_tool_image->resize($result['image'], 180, 180)
						);
					}
				}
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/english/common/header.php">
		<operation>
			<search position="after"><![CDATA[
				$_['text_all']           = 'See All';
			]]></search>
			<add><![CDATA[
				$_['text_product']       = 'products';
				$_['text_register_affiliate'] = 'Register as an affiliate';
				$_['text_login_affiliate'] = 'Login as an affiliate';
				$_['text_register_user'] = 'Register as a buyer';
				$_['text_loginser'] = 'Login as a buyer';
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/vietnamese/common/header.php">
		<operation>
			<search position="after"><![CDATA[
				$_['text_all']           = 'Xem tất cả';
			]]></search>
			<add><![CDATA[
				$_['text_product']       = 'Sản phẩm';
				$_['text_register_affiliate'] = 'Đăng ký đại lý';
				$_['text_login_affiliate'] = 'Đăng nhập đại lý';
				$_['text_register_user'] = 'Đăng ký người mua';
				$_['text_login_user'] = 'Đăng nhập người mua';
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="after"><![CDATA[
				$data['text_loading'] = $this->language->get('text_loading');
			]]></search>
			<add><![CDATA[
				$data['text_price'] = $this->language->get('text_price');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$data['tab_description'] = $this->language->get('tab_description');
			]]></search>
			<add><![CDATA[
				$data['tab_product_intro'] = $this->language->get('tab_product_intro');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
				$data['points'] = $product_info['points'];
			]]></search>
			<add><![CDATA[
				$data['meta_description'] = $product_info['meta_description'];
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/english/product/product.php">
		<operation>
			<search position="before"><![CDATA[
				$_['tab_description']                         = 'Description';
			]]></search>
			<add><![CDATA[
				$_['tab_product_intro']                       = 'Product introduction';
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/vietnamese/product/product.php">
		<operation>
			<search position="before"><![CDATA[
				$_['tab_description']   = 'Mô tả';
			]]></search>
			<add><![CDATA[
				$_['tab_product_intro']   = 'Giới thiệu sản phẩm';
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/common/footer.php">
		<operation>
			<search position="before"><![CDATA[
				if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/common/footer.tpl')) {
			]]></search>
			<add><![CDATA[
				// check affiliate
				if ( isset($this->session->data['tracking']) || $this->affiliate->isLogged() ) {
					if ( !$code = $this->affiliate->getCode() ) {
						$code = $this->session->data['tracking'];
					}
					$this->load->model('affiliate/affiliate');
					if ( $affiliate = $this->model_affiliate_affiliate->getAffiliateByCode($code) ) {
						$data['phone'] = $affiliate['telephone'];
						$data['address'] = $affiliate['address_1'];
						if (!empty($affiliate['address_2'])) {
							$data['address'] .= '<br>' . $affiliate['address_2'];
						}
						$data['email'] = $affiliate['email'];
					} else {
						$data['phone'] = $this->config->get('config_telephone');
						$data['address'] = $this->config->get('config_address');
						$data['email'] = $this->config->get('config_email');
					}
				} else {
					$data['phone'] = $this->config->get('config_telephone');
					$data['address'] = $this->config->get('config_address');
					$data['email'] = $this->config->get('config_email');
				}
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/common/home.php">
		<operation>
			<search position="before"><![CDATA[
				$data['column_left'] = $this->load->controller('common/column_left');
			]]></search>
			<add><![CDATA[
				$data['product_catalog'] = $this->url->link('product/categories', '', 'SSL');
				
				// check affiliate
				if ( isset($this->session->data['tracking']) || $this->affiliate->isLogged() ) {
					if ( !$code = $this->affiliate->getCode() ) {
						$code = $this->session->data['tracking'];
					}
					$this->load->model('affiliate/affiliate');
					if ( $affiliate = $this->model_affiliate_affiliate->getAffiliateByCode($code) ) {
						$data['phone'] = $affiliate['telephone'];
					} else {
						$data['phone'] = $this->config->get('config_telephone');
					}
				} else {
					$data['phone'] = $this->config->get('config_telephone');
				}

				$data['faq'] = $this->url->link('faq/list');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$data['column_left'] = $this->load->controller('common/column_left');
			]]></search>
			<add><![CDATA[
				$data['home_url'] = HTTP_SERVER;
				
				// Column 1
				$data['col_1_html'] = html_entity_decode($this->config->get('introduce_col_1_html'));
				$data['col_1_title'] = $this->config->get('introduce_col_1_title');
				$data['col_1_description'] = $this->config->get('introduce_col_1_description');
				$data['col_1_link'] = $this->config->get('introduce_col_1_link');
				
				// Column 2
				$data['col_2_html'] = html_entity_decode($this->config->get('introduce_col_2_html'));
				$data['col_2_title'] = $this->config->get('introduce_col_2_title');
				$data['col_2_description'] = $this->config->get('introduce_col_2_description');
				$data['col_2_link'] = $this->config->get('introduce_col_2_link');

				// Column 3
				$data['col_3_html'] = html_entity_decode($this->config->get('introduce_col_3_html'));
				$data['col_3_link'] = $this->config->get('introduce_col_3_link');

				// 4 Last news
				$this->load->model('news/news');
				$results = $this->model_news_news->getNewss(array(
					'sort' => 'nd.date_added',
					'order' => 'DESC',
					'start' => 0,
					'limit' => 4
				));

				$data['newses'] = array();
				foreach ($results as $news) {
					$data['newses'][] = array(
						'title' => $news['title'],
						'href' => $this->url->link('news/news', 'news_id=' . $news['news_id'], 'SSL')
					);
				}
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/affiliate/tracking.php">
		<operation>
			<search position="after"><![CDATA[
				$this->document->setTitle($this->language->get('heading_title'));
			]]></search>
			<add><![CDATA[
				$this->load->model('affiliate/affiliate');

				if (($this->request->server['REQUEST_METHOD'] == 'POST')) {
					$this->model_affiliate_affiliate->editTracking($this->request->post);

					$this->response->redirect($this->url->link('affiliate/account', '', 'SSL'));
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				$data['continue'] = $this->url->link('affiliate/account', '', 'SSL');
			]]></search>
			<add><![CDATA[
				$data['continue'] = $this->url->link('affiliate/tracking', '', 'SSL');
			]]></add>
		</operation>
	</file>
	<file name="catalog/model/affiliate/affiliate.php">
		<operation>
			<search position="before"><![CDATA[
				public function deleteLoginAttempts($email) {
			]]></search>
			<add><![CDATA[
				public function editTracking($data) {
					$this->event->trigger('pre.affiliate.edit.tracking', $data);
					
					if ($data['code'] == $this->affiliate->getCode()) return;
					
					$affiliate_id = $this->affiliate->getId();

					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "affiliate WHERE code = '" . $this->db->escape($data['code']) . "'");
					if ($total = $query->row['total'] > 0) {
						$data['code'] .= '-' . ($total + 1);
					}
					$this->db->query("UPDATE " . DB_PREFIX . "affiliate SET code = '" . $this->db->escape($data['code']) . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");

					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE query = 'affiliate_id=" . $affiliate_id . "'");
					
					if (isset($query->row['url_alias_id']) && $alias_id = $query->row['url_alias_id']) {
						$this->db->query("UPDATE " . DB_PREFIX . "url_alias SET keyword = '" . $data['code'] . "' WHERE url_alias_id = '" . $alias_id . "'");
					} else {
						$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET keyword = '" . $data['code'] . "', query = 'affiliate_id=" . $affiliate_id . "'");
					}

					$this->event->trigger('post.affiliate.edit.tracking', $affiliate_id);
				}
			]]></add>
		</operation>
		<operation>
	        <search position="replace"><![CDATA[
	        $this->db->query("UPDATE " . DB_PREFIX . "affiliate SET firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', company = '" . $this->db->escape($data['company']) . "', website = '" . $this->db->escape($data['website']) . "', address_1 = '" . $this->db->escape($data['address_1']) . "', address_2 = '" . $this->db->escape($data['address_2']) . "', city = '" . $this->db->escape($data['city']) . "', postcode = '" . $this->db->escape($data['postcode']) . "', country_id = '" . (int)$data['country_id'] . "', zone_id = '" . (int)$data['zone_id'] . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");
	        ]]></search>
	        <add><![CDATA[
	        $this->db->query("UPDATE " . DB_PREFIX . "affiliate SET firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', telephone = '" . $this->db->escape($data['telephone']) . "', fax = '" . $this->db->escape($data['fax']) . "', company = '" . $this->db->escape($data['company']) . "', website = '" . $this->db->escape($data['website']) . "', address_1 = '" . $this->db->escape($data['address_1']) . "', address_2 = '" . $this->db->escape($data['address_2']) . "', city = '" . $this->db->escape($data['city']) . "', postcode = '" . $this->db->escape($data['postcode']) . "', country_id = '" . (int)$data['country_id'] . "', zone_id = '" . (int)$data['zone_id'] . "', map_link = '" . $this->db->escape($data['map_link']) . "' WHERE affiliate_id = '" . (int)$affiliate_id . "'");
	        ]]></add>
        </operation>
	</file>
	<file name="catalog/controller/affiliate/edit.php">
		<operation>
			<search position="before"><![CDATA[
				if (isset($this->request->post['zone_id'])) {
			]]></search>
			
			<add><![CDATA[
				if (isset($this->request->post['map_link'])) {
			$data['map_link'] = $this->req4uest->post['map_link'];
		} elseif (!empty($affiliate_info) && !empty($affiliate_info['map_link'])) {
			$data['map_link'] = $affiliate_info['map_link'];
		} else {
			$data['map_link'] = '';
		}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
				$data['button_continue'] = $this->language->get('button_continue');
			]]></search>
			<add><![CDATA[
				$data['entry_map_link'] = $this->language->get('entry_map_link');
				$data['entry_guild_map_link'] = $this->language->get('entry_guild_map_link');
				$data['entry_click'] = $this->language->get('entry_click');
			]]></add>
		</operation>		
	</file>
	<file name="catalog/language/english/affiliate/edit.php">
		<operation>
			<search position="after"><![CDATA[State';]]></search>
			<add><![CDATA[
				$_['entry_map_link']        = 'Link Google Maps';
				$_['entry_guild_map_link']        = 'Guild to create Google Maps link, ';
				$_['entry_click']        = 'click here';
			]]></add>
		</operation>		
	</file>
	<file name="catalog/language/vietnamese/affiliate/edit.php">
		<operation>
			<search position="after"><![CDATA[
			$_['entry_zone']        = 'Tỉnh:';
			]]></search>
			<add><![CDATA[
				$_['entry_map_link']        = 'Link Google Maps';
				$_['entry_guild_map_link']        = 'Hướng dẫn tạo Google Maps link, ';
				$_['entry_click']        = 'click vào đây';
			]]></add>
		</operation>		
	</file>
	<file name="admin/language/english/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
			$_['entry_google_analytics']           = 'Google Analytics Code';
			]]></search>
			<add><![CDATA[
			$_['entry_map_link']                   = 'Link Google Maps';
			]]></add>
		</operation>		
	</file>
	<file name="admin/language/vietnamese/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
			$_['entry_name']                   = 'Tên cửa hàng:';
			]]></search>
			<add><![CDATA[
			$_['entry_map_link']                   = 'Link Google Maps';
			]]></add>
		</operation>		
	</file>
	<file name="admin/controller/setting/setting.php">
		<operation>
			<search position="after"><![CDATA[
			$data['entry_google_analytics'] = $this->language->get('entry_google_analytics');
			]]></search>
			<add><![CDATA[
				$data['entry_map_link'] = $this->language->get('entry_map_link');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$data['entry_google_analytics'] = $this->language->get('entry_google_analytics');
			]]></search>
			<add><![CDATA[
				$data['entry_map_link'] = $this->language->get('entry_map_link');
			]]></add>
		</operation>		
		<operation>
			<search position="before"><![CDATA[
					if (isset($this->request->post['config_geocode'])) {
			]]></search>
			<add><![CDATA[
			if (isset($this->request->post['config_map_link'])) {
			$data['config_map_link'] = $this->request->post['config_map_link'];
		} else {
			$data['config_map_link'] = $this->config->get('config_map_link');
		}
			]]></add>
		</operation>		
	</file>
	<file name="admin/view/template/setting/setting.tpl">
		<operation>
			<search position="before"><![CDATA[
			<label class="col-sm-2 control-label" for="input-geocode"><span data-toggle="tooltip" data-container="#tab-general" title="<?php echo $help_geocode; ?>"><?php echo $entry_geocode; ?></span></label>
			]]></search>
			<add><![CDATA[
				<label class="col-sm-2 control-label" for="input-map-link"><?php echo $entry_map_link ?></label>
                <div class="col-sm-10">
                  <input type="text" name="config_map_link" value="<?php echo $config_map_link ?>" placeholder="<?php $config_map_link ?>" id="input-map-link" class="form-control" />
                </div>
              </div>
              <div class="form-group">
			]]></add>
		</operation>		
	</file>
	<file name="catalog/controller/information/contact.php">
		<operation>
			<search position="before"><![CDATA[
				if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/information/contact.tpl')) {
			]]></search>
			<add><![CDATA[
				// check affiliate
				if ( isset($this->session->data['tracking']) || $this->affiliate->isLogged()) {
					if ( !$code = $this->affiliate->getCode() ) {
						$code = $this->session->data['tracking'];
					}
					$this->load->model('affiliate/affiliate');
					if ( $affiliate = $this->model_affiliate_affiliate->getAffiliateByCode($code) ) {
						if ( empty($affiliate['map_link']))
							$data['map_link'] = $this->config->get('config_map_link');
						else
							$data['map_link'] = $affiliate['map_link'];		
						$data['email'] = nl2br($affiliate['email']);
						$data['telephone'] = $affiliate['telephone'];	
						$data['address'] = nl2br($affiliate['address_1']);
						$data['address2'] = nl2br($affiliate['address_2']);		
					} else {
						$data['map_link'] = $this->config->get('config_map_link');
						$data['email'] = nl2br($this->config->get('config_email'));
						$data['telephone'] = $this->config->get('config_telephone');
						$data['address'] = nl2br($this->config->get('config_address'));
					}
				} else {
					$data['map_link'] = $this->config->get('config_map_link');
					$data['email'] = nl2br($this->config->get('config_email'));
					$data['telephone'] = $this->config->get('config_telephone');
					$data['address'] = nl2br($this->config->get('config_address'));
				}
			]]></add>
		</operation>
	</file>	
	<file name="catalog/controller/affiliate/register.php">
		<operation>
			<search position="before"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				/*
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="2"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				*/
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/account/register.php">
		<operation>
			<search position="before"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				/*
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="2"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				*/
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/guest.php">
		<operation>
			<search position="before"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				/*
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="2"><![CDATA[
				if ($country_info && $country_info['postcode_required'] && (utf8_strlen(trim($this->request->post['postcode'])) < 2 || utf8_strlen(trim($this->request->post['postcode'])) > 10)) {
			]]></search>
			<add><![CDATA[
				*/
			]]></add>
		</operation>		
	</file>
	<file name="catalog/language/vietnamese/affiliate/account.php">
		<operation>
			<search position="replace"><![CDATA[
				$_['text_tracking']        = 'Mã số Đại lý & Tạo các liên kết theo dõi của bạn';
			]]></search>
			<add><![CDATA[
				$_['text_tracking']        = 'Mã số đại lý & tùy chọn mã liên kết';
			]]></add>
		</operation>
	</file>
	<file name="catalog/model/affiliate/affiliate.php">
		<operation>
			<search position="replace"><![CDATA[
				$message .= $this->language->get('text_services') . "\n\n";
			]]></search>
			<add><![CDATA[
				$affiliate = $this->getAffiliate($affiliate_id);
				if (!empty($affiliate)) {
					$message .= $this->language->get('text_services');
					$message .= $this->url->link('common/home') . $affiliate['code'] . "\n\n";
				}
			]]></add>
		</operation>
	</file>
	<file name="catalog/model/checkout/order.php">
		<operation>
			<search position="before"><![CDATA[
				// Comment
			]]></search>
			<add><![CDATA[
				$this->load->model('affiliate/affiliate');
				$affiliate = $this->model_affiliate_affiliate->getAffiliate($order_info['affiliate_id']);
				if (!empty($affiliate)) {
					$mail = new Mail($this->config->get('config_mail'));
					$mail->setTo($affiliate['email']);
					$mail->setFrom($this->config->get('config_email'));
					$mail->setSender($order_info['store_name']);
					$mail->setSubject($subject);
					$mail->setHtml($html);
					$mail->setText($text);
					$mail->send();
				}
			]]></add>
		</operation>
	</file>
</modification>
